---

- name: "Add hugepages to sysctl.conf"
  lineinfile:
    path: /etc/sysctl.conf
    regexp: 'nr_hugepages'
    line: vm.nr_hugepages = 1024
  register: set_hugepage_sysctl

# You can verify with `cat /proc/meminfo | grep Huge`

- name: Reload sysctl
  shell: >
    sysctl -p
  when: set_hugepage_sysctl.changed

# VPP installation
# sudo yum install centos-release-fdio
# sudo yum install vpp*

- name: Install jq binary
  get_url:
    url: https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64
    dest: /usr/bin/jq

- name: set jq binary permission
  file:
    path: /usr/bin/jq
    mode: 0755

- name: Install VPP repo
  yum:
    name: "centos-release-fdio"
    state: latest

- name: Install VPP
  yum:
    name: "vpp*"
    state: latest

- name: Start & Enable VPP
  service:
    name: "vpp"
    state: started
    enabled: yes

- name: Ensure git is installed
  yum:
    name: git
    state: present

- name: Clone Userspace CNI Plugin repo
  git:
    repo: https://github.com/Billy99/user-space-net-plugin.git
    dest: "{{ ansible_env.HOME }}/src/go/src/github.com/Billy99/user-space-net-plugin"
    force: true

- name: Build Userspace CNI plugin
  shell: >
    export GOPATH={{ ansible_env.HOME }}/src/go; make
  args:
    chdir: "{{ ansible_env.HOME }}/src/go/src/github.com/Billy99/user-space-net-plugin"
    creates: "{{ ansible_env.HOME }}/src/go/src/github.com/Billy99/user-space-net-plugin/userspace/userspace"

- name: Copy Userspace CNI plugin to CNI bin dir
  shell: >
    cp userspace/userspace /opt/cni/bin/userspace
  args:
    chdir: "{{ ansible_env.HOME }}/src/go/src/github.com/Billy99/user-space-net-plugin"
    creates: "/opt/cni/bin/userspace"

- name: Clone CNI repo
  git:
    repo: https://github.com/containernetworking/cni.git
    dest: "{{ ansible_env.HOME }}/src/go/src/github.com/containernetworking/cni"

- name: Make an alternate cni net.d dir
  file:
    path: /etc/alternate.net.d/
    state: directory

- name: Template userspace CNI config
  template:
    src: 90-userspace.conf.j2
    dest: /etc/alternate.net.d/90-userspace.conf 

# manually... to run the demo.
# $ docker pull bmcfall/vpp-centos-userspace-cni:0.2.0
# $ cp userspace/userspace /opt/cni/bin/
# $ sed -i -e 's|vpp-centos-userspace-cni|bmcfall/vpp-centos-userspace-cni:0.2.0|' scripts/vpp-docker-run.sh 
# $ export CNI_PATH=/opt/cni/bin; export NETCONFPATH=/etc/alternate.net.d/; export GOPATH=/root/src/go/; ./scripts/vpp-docker-run.sh -it --privileged docker.io/bmcfall/vpp-centos-userspace-cni:0.2.0
# ------ in container
# vppctl show interface
# vppctl show mode
# vppctl show memif
# create two of 'em and do:
# vppctl ping 192.168.210.2   

